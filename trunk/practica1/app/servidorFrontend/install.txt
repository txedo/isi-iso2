CREATE DATABASE bdssca CHARACTER SET utf8 COLLATE utf8_bin;
USE bdssca;

CREATE TABLE centros (
       id INT NOT NULL AUTO_INCREMENT,
       nombre VARCHAR(255) UNIQUE NOT NULL default '', 
       direccion VARCHAR(255) NOT NULL default '', 
       PRIMARY KEY (id)
) TYPE=InnoDB AUTO_INCREMENT=1;

CREATE TABLE usuarios (
       nif VARCHAR(255) NOT NULL, 
       login VARCHAR(255) UNIQUE NOT NULL default '',
       password VARCHAR(255) NOT NULL default '', 
       rol INT NOT NULL default '-1',
       nombre VARCHAR(255) NOT NULL default '',
       apellidos VARCHAR(255) NOT NULL default '',
       idCentro INT default '-1',
       PRIMARY KEY (nif),
       FOREIGN KEY (idCentro) REFERENCES centros (id) ON DELETE SET NULL ON UPDATE CASCADE
) TYPE=InnoDB;

CREATE TABLE tiposMedico (
       dniMedico VARCHAR(255) NOT NULL,
       tipo ENUM ('Cabecera', 'Pediatra', 'Especialista') NOT NULL,
       especialidad VARCHAR(255) NOT NULL default '',
       PRIMARY KEY (dniMedico),
       FOREIGN KEY (dniMedico) REFERENCES usuarios (nif) ON DELETE NO ACTION ON UPDATE CASCADE
) TYPE=InnoDB;

CREATE TABLE periodosTrabajo (
       id INT NOT NULL AUTO_INCREMENT,
       dniMedico VARCHAR(255) NOT NULL,
       horaInicio INT NOT NULL,
       horaFinal INT NOT NULL,
       dia INT NOT NULL,
       PRIMARY KEY (id),
       FOREIGN KEY (dniMedico) REFERENCES usuarios (nif) ON DELETE NO ACTION ON UPDATE CASCADE
) TYPE=InnoDB;

CREATE TABLE entradasLog (
       id INT NOT NULL AUTO_INCREMENT,
       usuario VARCHAR(255) NOT NULL,
       fecha DATETIME NOT NULL,
       accion ENUM ('create', 'read', 'update', 'delete') NOT NULL,
       mensaje VARCHAR(255) NOT NULL,
       PRIMARY KEY (id)
) TYPE=InnoDB AUTO_INCREMENT=1;

CREATE TABLE beneficiarios (
       nif VARCHAR(255) NOT NULL,
       nss VARCHAR(255) UNIQUE NOT NULL,
       nombre VARCHAR(255) NOT NULL default '', 
       apellidos VARCHAR(255) NOT NULL default '',
       domicilio VARCHAR(255) NOT NULL default '',
       numeroDomicilio VARCHAR(255) default '',
       pisoDomicilio VARCHAR(255) default '',
       puertaDomicilio VARCHAR(255) default '',
       ciudad VARCHAR(255) NOT NULL default '',
       provincia VARCHAR(255) NOT NULL default '',
       cp INT NOT NULL default -1,
       correo VARCHAR(255) default '',
       fechaNacimiento DATETIME NOT NULL,
       telefono VARCHAR(255) default '-1',
       movil VARCHAR(255) default '-1',
       dniMedico VARCHAR(255) default '',
       PRIMARY KEY (nif),
       FOREIGN KEY (dniMedico) REFERENCES usuarios (nif) ON DELETE SET NULL ON UPDATE CASCADE
) TYPE=InnoDB;

CREATE TABLE citas (
       id INT NOT NULL AUTO_INCREMENT,
       fecha DATETIME NOT NULL,
       duracion INT NOT NULL,
       nifBeneficiario VARCHAR(255) NOT NULL,
       dniMedico VARCHAR(255) NOT NULL,
       PRIMARY KEY (id),
       FOREIGN KEY (nifBeneficiario) REFERENCES beneficiarios (nif) ON DELETE CASCADE ON UPDATE CASCADE,
       FOREIGN KEY (dniMedico) REFERENCES usuarios (nif) ON DELETE CASCADE ON UPDATE CASCADE
) TYPE=InnoDB AUTO_INCREMENT=1;

CREATE TABLE volantes (
       id INT NOT NULL AUTO_INCREMENT,
       nifBeneficiario VARCHAR(255) NOT NULL,
       dniMedicoEmisor VARCHAR(255) NOT NULL,
       dniMedicoReceptor VARCHAR(255) NOT NULL,
       PRIMARY KEY (id),
       FOREIGN KEY (nifBeneficiario) REFERENCES beneficiarios (nif) ON DELETE CASCADE ON UPDATE CASCADE,
       FOREIGN KEY (dniMedicoEmisor) REFERENCES usuarios (nif) ON DELETE CASCADE ON UPDATE CASCADE,
       FOREIGN KEY (dniMedicoReceptor) REFERENCES usuarios (nif) ON DELETE CASCADE ON UPDATE CASCADE
) TYPE=InnoDB AUTO_INCREMENT=1;

CREATE TABLE sustituciones (
       id INT NOT NULL AUTO_INCREMENT,
       dia DATETIME NOT NULL,
       horaInicio INT NOT NULL,
       horaFinal INT NOT NULL,
       dniMedico VARCHAR(255) NOT NULL,
       dniSustituto VARCHAR(255) NOT NULL,
       PRIMARY KEY (id),
       FOREIGN KEY (dniMedico) REFERENCES usuarios (nif) ON DELETE CASCADE ON UPDATE CASCADE,
       FOREIGN KEY (dniSustituto) REFERENCES usuarios (nif) ON DELETE CASCADE ON UPDATE CASCADE
) TYPE=InnoDB AUTO_INCREMENT=1;

INSERT INTO centros (nombre,direccion) VALUES ("Centro de Pruebas", "Paseo de la Universidad, 4");
INSERT INTO usuarios VALUES ("11111111A", "admin", password("admin"), 0, "Foo", "Bar", 1);
INSERT INTO usuarios VALUES ("11111111C", "citador", password("citador"), 1, "Foo", "Bar", 1);
INSERT INTO usuarios VALUES ("12345678C", "cabecera", password("cabecera"), 2, "Foo", "Bar", 1);
INSERT INTO tiposmedico (dniMedico, tipo) VALUES ("12345678C", "Cabecera");
INSERT INTO usuarios VALUES ("12345678P", "pediatra", password("pediatra"), 2, "Foo", "Bar", 1);
INSERT INTO tiposmedico (dniMedico, tipo) VALUES  ("12345678P", "Pediatra");
INSERT INTO usuarios VALUES ("12345678E", "especialista", password("especialista"), 2, "Foo", "Bar", 1);
INSERT INTO tiposmedico VALUES ("12345678E", "Especialista", "Neurologia");
